#!/usr/bin/env python3
"""
ç®¡ç†å‘˜æƒé™å·¥å…·æ¨¡å— - FlowDeskæƒé™ç®¡ç†æ ¸å¿ƒ

è¿™ä¸ªæ¨¡å—æä¾›Windows UACæƒé™æ£€æŸ¥å’Œç”³è¯·åŠŸèƒ½ï¼Œç¡®ä¿FlowDeskèƒ½å¤Ÿä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œï¼Œ
ä»è€Œæ‰§è¡Œéœ€è¦æå‡æƒé™çš„ç½‘ç»œé…ç½®æ“ä½œï¼ˆå¦‚netshå‘½ä»¤ï¼‰ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
1. æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦å…·æœ‰ç®¡ç†å‘˜æƒé™
2. ä»¥ç®¡ç†å‘˜æƒé™é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº
3. æä¾›ç”¨æˆ·å‹å¥½çš„æƒé™ç”³è¯·æç¤º

è®¾è®¡åŸåˆ™ï¼š
- éµå¾ªWindowså®‰å…¨æœ€ä½³å®è·µ
- æä¾›æ¸…æ™°çš„ç”¨æˆ·æç¤ºä¿¡æ¯
- ç¡®ä¿æƒé™ç”³è¯·çš„é€æ˜æ€§å’Œå®‰å…¨æ€§
"""

import sys
import os
import ctypes
import subprocess


def is_admin() -> bool:
    """
    æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦å…·æœ‰ç®¡ç†å‘˜æƒé™
    
    ä½¿ç”¨Windows APIæ£€æŸ¥å½“å‰ç”¨æˆ·ä»¤ç‰Œæ˜¯å¦å…·æœ‰ç®¡ç†å‘˜æƒé™ã€‚
    è¿™æ˜¯ç¡®å®šæ˜¯å¦éœ€è¦UACæå‡çš„å…³é”®æ–¹æ³•ã€‚
    
    Returns:
        bool: Trueè¡¨ç¤ºå…·æœ‰ç®¡ç†å‘˜æƒé™ï¼ŒFalseè¡¨ç¤ºæ™®é€šç”¨æˆ·æƒé™
        
    Raises:
        æ— ç›´æ¥å¼‚å¸¸æŠ›å‡ºï¼Œæƒé™æ£€æŸ¥å¤±è´¥æ—¶è¿”å›False
    """
    try:
        # ä½¿ç”¨ctypesè°ƒç”¨Windows APIæ£€æŸ¥ç®¡ç†å‘˜æƒé™
        # shell32.IsUserAnAdmin()è¿”å›éé›¶å€¼è¡¨ç¤ºå…·æœ‰ç®¡ç†å‘˜æƒé™
        return ctypes.windll.shell32.IsUserAnAdmin() != 0
    except Exception:
        # æƒé™æ£€æŸ¥å¤±è´¥æ—¶ï¼Œå‡è®¾æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œç¡®ä¿å®‰å…¨
        return False


def run_as_admin(script_path: str = None) -> bool:
    """
    ä»¥ç®¡ç†å‘˜æƒé™é‡æ–°å¯åŠ¨å½“å‰åº”ç”¨ç¨‹åº
    
    ä½¿ç”¨Windows ShellExecute APIä»¥ç®¡ç†å‘˜æƒé™é‡æ–°å¯åŠ¨ç¨‹åºã€‚
    è¿™ä¼šè§¦å‘UACå¯¹è¯æ¡†ï¼Œè¦æ±‚ç”¨æˆ·ç¡®è®¤æƒé™æå‡ã€‚
    
    Args:
        script_path (str, optional): è¦ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œçš„è„šæœ¬è·¯å¾„
                                   å¦‚æœä¸ºNoneï¼Œåˆ™ä½¿ç”¨å½“å‰è„šæœ¬è·¯å¾„
    
    Returns:
        bool: Trueè¡¨ç¤ºæˆåŠŸå¯åŠ¨ç®¡ç†å‘˜è¿›ç¨‹ï¼ŒFalseè¡¨ç¤ºå¯åŠ¨å¤±è´¥æˆ–ç”¨æˆ·æ‹’ç»
        
    Note:
        æˆåŠŸå¯åŠ¨ç®¡ç†å‘˜è¿›ç¨‹åï¼Œå½“å‰è¿›ç¨‹åº”è¯¥é€€å‡º
    """
    try:
        # ç¡®å®šè¦é‡æ–°å¯åŠ¨çš„è„šæœ¬è·¯å¾„
        if script_path is None:
            script_path = sys.argv[0]
        
        # è·å–Pythonè§£é‡Šå™¨è·¯å¾„
        python_exe = sys.executable
        
        # æ„å»ºå‘½ä»¤è¡Œå‚æ•°
        # ä¿æŒåŸæœ‰çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œç¡®ä¿ç¨‹åºè¡Œä¸ºä¸€è‡´
        params = ' '.join([f'"{script_path}"'] + sys.argv[1:])
        
        # ä½¿ç”¨ShellExecute APIä»¥ç®¡ç†å‘˜æƒé™å¯åŠ¨è¿›ç¨‹
        # "runas"åŠ¨è¯ä¼šè§¦å‘UACæƒé™æå‡å¯¹è¯æ¡†
        result = ctypes.windll.shell32.ShellExecuteW(
            None,                    # hwnd: çˆ¶çª—å£å¥æŸ„
            "runas",                # lpOperation: æ“ä½œç±»å‹ï¼ˆrunasè¡¨ç¤ºä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œï¼‰
            python_exe,             # lpFile: è¦æ‰§è¡Œçš„ç¨‹åº
            params,                 # lpParameters: å‘½ä»¤è¡Œå‚æ•°
            None,                   # lpDirectory: å·¥ä½œç›®å½•
            1                       # nShowCmd: æ˜¾ç¤ºæ–¹å¼ï¼ˆ1=SW_SHOWNORMALï¼‰
        )
        
        # ShellExecuteè¿”å›å€¼å¤§äº32è¡¨ç¤ºæˆåŠŸ
        return result > 32
        
    except Exception as e:
        print(f"ä»¥ç®¡ç†å‘˜æƒé™å¯åŠ¨å¤±è´¥: {e}")
        return False


def ensure_admin_privileges() -> bool:
    """
    ç¡®ä¿åº”ç”¨ç¨‹åºå…·æœ‰ç®¡ç†å‘˜æƒé™çš„æ ¸å¿ƒæ§åˆ¶æ–¹æ³•
    
    è¿™ä¸ªæ–¹æ³•æ˜¯FlowDeskæƒé™ç®¡ç†çš„å…¥å£ç‚¹ï¼Œè´Ÿè´£æ£€æŸ¥å½“å‰æƒé™çŠ¶æ€ï¼Œ
    å¹¶åœ¨éœ€è¦æ—¶å¼•å¯¼ç”¨æˆ·è¿›è¡Œæƒé™æå‡ã€‚é‡‡ç”¨ç”¨æˆ·å‹å¥½çš„äº¤äº’è®¾è®¡ï¼Œ
    ç¡®ä¿æƒé™ç”³è¯·è¿‡ç¨‹çš„é€æ˜æ€§ã€‚
    
    å·¥ä½œæµç¨‹ï¼š
    1. æ£€æŸ¥å½“å‰æ˜¯å¦å·²å…·æœ‰ç®¡ç†å‘˜æƒé™
    2. å¦‚æœæ²¡æœ‰æƒé™ï¼Œæ˜¾ç¤ºå‹å¥½æç¤ºä¿¡æ¯
    3. å°è¯•ä»¥ç®¡ç†å‘˜æƒé™é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº
    4. é€€å‡ºå½“å‰è¿›ç¨‹ï¼Œç­‰å¾…ç®¡ç†å‘˜è¿›ç¨‹å¯åŠ¨
    
    Returns:
        bool: Trueè¡¨ç¤ºå·²å…·æœ‰ç®¡ç†å‘˜æƒé™ï¼ŒFalseè¡¨ç¤ºæƒé™è·å–å¤±è´¥
        
    Note:
        å¦‚æœæˆåŠŸå¯åŠ¨ç®¡ç†å‘˜è¿›ç¨‹ï¼Œæ­¤æ–¹æ³•ä¸ä¼šè¿”å›ï¼ˆè¿›ç¨‹ä¼šé€€å‡ºï¼‰
    """
    # é¦–å…ˆæ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»å…·æœ‰ç®¡ç†å‘˜æƒé™
    if is_admin():
        print("âœ… å·²å…·æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå¯ä»¥æ‰§è¡Œç½‘ç»œé…ç½®æ“ä½œ")
        return True
    
    print("âš ï¸  FlowDeskéœ€è¦ç®¡ç†å‘˜æƒé™æ¥ä¿®æ”¹ç½‘ç»œé…ç½®")
    print("ğŸ“‹ å°†è¦æ‰§è¡Œçš„æ“ä½œï¼š")
    print("   â€¢ ä¿®æ”¹ç½‘å¡IPåœ°å€é…ç½®")
    print("   â€¢ è®¾ç½®DNSæœåŠ¡å™¨")
    print("   â€¢ é…ç½®ç½‘å…³ä¿¡æ¯")
    print()
    print("ğŸ”’ æ­£åœ¨ç”³è¯·ç®¡ç†å‘˜æƒé™...")
    print("   è¯·åœ¨UACå¯¹è¯æ¡†ä¸­ç‚¹å‡»\"æ˜¯\"ä»¥ç»§ç»­")
    
    # å°è¯•ä»¥ç®¡ç†å‘˜æƒé™é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº
    if run_as_admin():
        print("âœ… ç®¡ç†å‘˜æƒé™ç”³è¯·æˆåŠŸï¼Œæ­£åœ¨é‡æ–°å¯åŠ¨...")
        # æˆåŠŸå¯åŠ¨ç®¡ç†å‘˜è¿›ç¨‹åï¼Œå½“å‰è¿›ç¨‹åº”è¯¥é€€å‡º
        # è¿™é¿å…äº†åŒæ—¶è¿è¡Œä¸¤ä¸ªå®ä¾‹çš„é—®é¢˜
        sys.exit(0)
    else:
        print("âŒ ç®¡ç†å‘˜æƒé™ç”³è¯·å¤±è´¥æˆ–è¢«ç”¨æˆ·æ‹’ç»")
        print("ğŸ’¡ æç¤ºï¼š")
        print("   â€¢ è¯·ç¡®ä¿ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ­¤ç¨‹åº")
        print("   â€¢ æˆ–è€…åœ¨UACå¯¹è¯æ¡†ä¸­ç‚¹å‡»\"æ˜¯\"")
        print("   â€¢ æ²¡æœ‰ç®¡ç†å‘˜æƒé™å°†æ— æ³•ä¿®æ”¹ç½‘ç»œé…ç½®")
        return False


def check_network_admin_capability() -> bool:
    """
    æ£€æŸ¥ç½‘ç»œç®¡ç†èƒ½åŠ›çš„ä¸“ç”¨éªŒè¯æ–¹æ³•
    
    é€šè¿‡å°è¯•æ‰§è¡Œä¸€ä¸ªå®‰å…¨çš„netshå‘½ä»¤æ¥éªŒè¯æ˜¯å¦å…·æœ‰ç½‘ç»œé…ç½®æƒé™ã€‚
    è¿™æ¯”ç®€å•çš„ç®¡ç†å‘˜æƒé™æ£€æŸ¥æ›´å‡†ç¡®ï¼Œå› ä¸ºæŸäº›ä¼ä¸šç¯å¢ƒå¯èƒ½æœ‰ç‰¹æ®Šçš„æƒé™ç­–ç•¥ã€‚
    
    Returns:
        bool: Trueè¡¨ç¤ºå…·æœ‰ç½‘ç»œé…ç½®æƒé™ï¼ŒFalseè¡¨ç¤ºæƒé™ä¸è¶³
    """
    try:
        # æ‰§è¡Œä¸€ä¸ªå®‰å…¨çš„netshæŸ¥è¯¢å‘½ä»¤æ¥æµ‹è¯•æƒé™
        # è¿™ä¸ªå‘½ä»¤ä¸ä¼šä¿®æ”¹ä»»ä½•é…ç½®ï¼Œåªæ˜¯æŸ¥è¯¢æ¥å£åˆ—è¡¨
        result = subprocess.run(
            ['netsh', 'interface', 'ipv4', 'show', 'interfaces'],
            capture_output=True,
            text=True,
            timeout=10,
            encoding='gbk',
            errors='replace'
        )
        
        # å¦‚æœå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼Œè¯´æ˜å…·æœ‰åŸºæœ¬çš„ç½‘ç»œæŸ¥è¯¢æƒé™
        # é€šå¸¸å…·æœ‰æŸ¥è¯¢æƒé™çš„ç”¨æˆ·ä¹Ÿå…·æœ‰é…ç½®æƒé™ï¼ˆåœ¨ç®¡ç†å‘˜æ¨¡å¼ä¸‹ï¼‰
        return result.returncode == 0
        
    except Exception:
        # å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™ä¸è¶³æˆ–ç³»ç»Ÿé—®é¢˜
        return False


def get_elevation_status_message() -> str:
    """
    è·å–å½“å‰æƒé™çŠ¶æ€çš„ç”¨æˆ·å‹å¥½æè¿°ä¿¡æ¯
    
    Returns:
        str: æƒé™çŠ¶æ€æè¿°æ–‡æœ¬
    """
    if is_admin():
        if check_network_admin_capability():
            return "âœ… ç®¡ç†å‘˜æƒé™ - å¯ä»¥ä¿®æ”¹ç½‘ç»œé…ç½®"
        else:
            return "âš ï¸  ç®¡ç†å‘˜æƒé™ - ç½‘ç»œé…ç½®åŠŸèƒ½å—é™"
    else:
        return "âŒ æ™®é€šç”¨æˆ·æƒé™ - éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½ä¿®æ”¹ç½‘ç»œé…ç½®"


if __name__ == "__main__":
    """
    æƒé™å·¥å…·çš„ç‹¬ç«‹æµ‹è¯•å…¥å£
    
    å¯ä»¥ç›´æ¥è¿è¡Œæ­¤æ¨¡å—æ¥æµ‹è¯•æƒé™æ£€æŸ¥å’Œç”³è¯·åŠŸèƒ½
    """
    print("FlowDesk æƒé™ç®¡ç†å·¥å…·æµ‹è¯•")
    print("=" * 40)
    
    print(f"å½“å‰æƒé™çŠ¶æ€: {get_elevation_status_message()}")
    print(f"ç®¡ç†å‘˜æƒé™: {'æ˜¯' if is_admin() else 'å¦'}")
    print(f"ç½‘ç»œé…ç½®èƒ½åŠ›: {'æ˜¯' if check_network_admin_capability() else 'å¦'}")
    
    if not is_admin():
        print("\næµ‹è¯•æƒé™ç”³è¯·åŠŸèƒ½...")
        ensure_admin_privileges()
