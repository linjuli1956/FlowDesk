# FlowDesk 现有目录结构说明

## 📋 强制约束清单 | 一句话规则

1. **UI 严禁业务逻辑**，只能调用 Service 方法并接收 PyQt 信号。
2. **禁止出现裸 dict**，数据一律用 `@dataclass(frozen=True)`。
3. **禁止内联样式**，所有样式走外置 QSS；文件（不含注释）>400 行即拆分。
4. **资源路径必须 `resource_path()`**，图标统一放 `assets/icons/`。
5. **任何仅 Win10/11 功能**在 Win7 环境自动降级并弹提示。
6. **每新增文件须在 `__init__.py` 导出**，保持"一处导入"原则。
7. **单元测试必须覆盖新增 Service 公共方法**。

## 📋新建 xxx.py，按四层架构落位： 
> 1. 首行 `# -*- coding: utf-8 -*-` 
> 2. 第二行开始写【文件用途｜写给初学者】  简洁明了
示例范本：
-----------------------------------------------
# -*- coding: utf-8 -*-
"""
网卡发现服务：负责枚举并排序本机所有网络适配器
"""
from typing import List
from dataclasses import dataclass
from ..models.adapter_info import AdapterInfo

class AdapterDiscoveryService:
    """通过 WMI 获取网卡列表并排序"""
    def discover(self) -> List[AdapterInfo]:
        """返回按名称排序的 AdapterInfo 列表"""
        # 核心逻辑...
        return []
-----------------------------------------------
> 3. 类/方法中文 docstring  
> 4. 数据类 `@dataclass(frozen=True)`  
> 5. 行内关键逻辑中文注释  
> 6. 文件 ≤400 行，超即拆包  
> 每个功能按 **UI-Service-Model-Utils** 四层落位；每层内部用面向对象：数据类 frozen 只读、Service 单职责、UI 只收信号，超 400 行标注拆包

---

## 🏗️ 项目整体架构

```
FlowDesk/
├── 📁 assets/                    # 静态资源目录
│   ├── icons/                    # 图标文件 (统一存放)
│   └── LibreHardwareMonitor/     # 硬件监控依赖
├── 📁 config/                    # 配置管理层
├── 📁 src/flowdesk/             # 主程序源码
│   ├── 📁 models/               # 数据模型层 (Model)
│   ├── 📁 services/             # 业务服务层 (Service)
│   ├── 📁 ui/                   # 用户界面层 (UI)
│   └── 📁 utils/                # 工具函数层 (Utils)
├── 📁 tests/                    # 单元测试
├── 📁 docs/                     # 项目文档
├── 📁 scripts/                  # 构建脚本
└── 📁 myplan/                   # 开发计划文档
```

---

## 📊 代码量统计与拆分建议

### 🚨 超过 400 行需拆分的文件

| 文件路径 | 行数 | 拆分建议 | 优先级 |
|---------|------|----------|--------|
| `src/flowdesk/ui/main_window.py` | **1414行** | 拆分为主窗口基类 + Tab管理器 + 事件处理器 | 🔴 高 |
| `src/flowdesk/services/network/adapter_info_service.py` | **786行** | 拆分为信息获取器 + 状态解析器 + 配置解析器 | 🔴 高 |
| `src/flowdesk/utils/network_utils.py` | **631行** | 按功能拆分：IP验证 + DNS工具 + 网络计算 | 🟡 中 |
| `src/flowdesk/utils/subprocess_helper.py` | **574行** | 拆分为同步执行器 + 异步执行器 | 🟡 中 |
| `src/flowdesk/services/network/network_ui_coordinator_service.py` | **547行** | 拆分为协调器基类 + UI事件处理器 | 🟡 中 |

### 🚨 需要拆分的文件 (超过400行)

| 文件路径 | 行数 | 拆分建议 | 优先级 |
|---------|------|----------|--------|
| `src/flowdesk/services/network/network_service.py` | **481行** | 拆分为门面服务 + 具体实现服务 | 🟡 中 |
| `src/flowdesk/utils/capabilities.py` | **422行** | 拆分为系统检测 + 权限检测 + 硬件检测 | 🟡 中 |
| `src/flowdesk/services/network/ip_configuration_service.py` | **426行** | 拆分为IP配置器 + DNS配置器 | 🟡 中 |
| `src/flowdesk/services/system_tray_service.py` | **412行** | 拆分为托盘管理器 + 菜单处理器 | 🟡 中 |

---

## 📁 详细目录结构

### 🔧 配置管理层 (config/)
```
config/
├── __init__.py                   # 配置模块导出 (30行)
├── settings.py                   # 基础配置类 (333行)
├── development.py                # 开发环境配置 (275行)
└── production.py                 # 生产环境配置 (375行)
```
**职责**: 环境配置、应用设置、日志配置管理

### 📊 数据模型层 (models/)
```
models/
├── __init__.py                   # 模型导出 (35行)
├── adapter_info.py               # 网卡信息模型 (245行) ✅
├── common.py                     # 通用数据模型 (47行)
├── hardware_metrics.py          # 硬件监控模型 (49行)
├── network_tools.py             # 网络工具模型 (48行)
└── rdp_session.py               # 远程桌面模型 (36行)
```
**职责**: 数据结构定义、类型约束、业务实体建模
**规范**: 全部使用 `@dataclass(frozen=True)` 确保不可变性

### ⚙️ 业务服务层 (services/)
```
services/
├── __init__.py                   # 服务层导出 (40行)
├── stylesheet_service.py        # 样式管理服务 (267行) ✅
├── system_tray_service.py       # 系统托盘服务 (412行) ✅
└── network/                     # 网络服务子模块
    ├── __init__.py              # 网络服务导出 (104行)
    ├── network_service_base.py  # 网络服务基类 (147行)
    ├── network_service.py       # 网络服务门面 (481行) ✅
    ├── adapter_discovery_service.py      # 网卡发现服务 (375行) ✅
    ├── adapter_info_service.py           # 网卡信息服务 (786行) 🚨
    ├── adapter_performance_service.py    # 网卡性能服务 (378行) ✅
    ├── adapter_status_service.py         # 网卡状态服务 (389行) ✅
    ├── network_ui_coordinator_service.py # UI协调服务 (547行) 🚨
    ├── ip_configuration_service.py       # IP配置服务 (426行) ✅
    └── extra_ip_management_service.py    # 额外IP管理 (375行) ✅
```
**职责**: 业务逻辑封装、外部API调用、数据处理
**规范**: 单一职责原则、依赖注入、信号通信

### 🎨 用户界面层 (ui/)
```
ui/
├── __init__.py                   # UI层导出 (41行)
├── main_window.py               # 主窗口 (1414行) 🚨 需拆分
├── qss/                         # QSS样式文件目录
│   └── __init__.py              # QSS模块导出
├── styles/                      # 样式管理
│   ├── __init__.py              # 样式导出
│   └── color_scheme.py          # 颜色方案 (已实现)
├── tabs/                        # Tab页面组件
│   ├── __init__.py              # Tab导出 (33行)
│   ├── network_config_tab.py    # 网络配置Tab主容器 (314行) ✅
│   ├── adapter_info_panel.py    # 网卡信息面板 (已拆分) ✅
│   ├── ip_config_panel.py       # IP配置面板 (已拆分) ✅
│   └── network_config_handlers.py # 事件处理器 (已拆分) ✅
├── dialogs/                     # 对话框组件
│   ├── __init__.py              # 对话框导出
│   └── add_ip_dialog.py         # 添加IP对话框 (357行) ✅
└── widgets/                     # 自定义组件
    ├── __init__.py              # 组件导出
    ├── validators.py            # 输入验证器 (229行) ✅
    └── custom_text_edit.py      # 自定义文本编辑器 ✅
```
**职责**: 界面显示、用户交互、信号发射
**规范**: 严禁业务逻辑、只调用Service、遵循UI四大铁律

### 🛠️ 工具函数层 (utils/)
```
utils/
├── __init__.py                   # 工具导出 (33行)
├── admin_utils.py               # 管理员权限工具 (207行) ✅
├── capabilities.py              # 系统能力检测 (422行) ✅
├── logger.py                    # 日志管理工具 (394行) ✅
├── network_utils.py             # 网络工具函数 (631行) 🚨 需拆分
├── resource_path.py             # 资源路径工具 (287行) ✅
└── subprocess_helper.py         # 子进程辅助 (574行) 🚨 需拆分
```
**职责**: 通用工具函数、系统调用封装、辅助功能
**规范**: 纯函数设计、无状态、可复用

---

## 🔄 拆分建议详情

### 1. 🚨 main_window.py (1414行) → 拆分方案
```python
# 建议拆分为 4 个文件:
main_window_base.py      # 基础窗口类 (~400行)
tab_manager.py           # Tab页面管理器 (~300行)  
window_event_handler.py  # 事件处理器 (~400行)
window_ui_components.py  # UI组件管理器 (~300行)
```

### 2. ✅ network_config_tab.py → 已完成拆分
```python
# 已拆分为 4 个文件:
network_config_tab.py         # Tab主容器 (314行) ✅
adapter_info_panel.py         # 左侧网卡信息面板 ✅
ip_config_panel.py           # 右侧IP配置面板 ✅
network_config_handlers.py   # 事件处理器 ✅
```

### 3. 🚨 network_utils.py (631行) → 拆分方案
```python
# 拆分为 3 个文件:
ip_validation_utils.py   # IP地址验证工具 (~200行)
dns_utils.py            # DNS相关工具 (~200行)
network_calc_utils.py   # 网络计算工具 (~200行)
```

### 4. 🚨 subprocess_helper.py (574行) → 拆分方案
```python
# 拆分为 2 个文件:
sync_subprocess_helper.py   # 同步执行器 (~300行)
async_subprocess_helper.py  # 异步执行器 (~250行)
```

---

## 📝 开发注意事项

### 🎯 UI四大铁律遵循检查
- ✅ **禁止样式重复**: 通过 StylesheetService 统一管理
- ✅ **严格自适应布局**: 所有UI组件支持动态调整
- ✅ **最小宽度保护**: 防止界面过度压缩
- ✅ **智能组件缩放**: 根据内容自动调整大小

### 🔒 面向对象架构原则
1. **封装性**: 数据和方法封装在类内部
2. **单一职责**: 每个类只负责一项功能
3. **开闭原则**: 对扩展开放，对修改封闭
4. **依赖倒置**: 依赖抽象而非具体实现
5. **接口分离**: 接口细化，避免不必要的依赖

### 📦 模块导入规范
- 每个 `__init__.py` 必须包含 `__all__` 列表
- 新增文件必须在对应的 `__init__.py` 中导出
- 保持"一处导入"原则，避免循环依赖

### 🧪 测试覆盖要求
- 所有 Service 层公共方法必须有单元测试
- UI 层重点测试信号发射和槽函数连接
- 工具函数层要求 100% 测试覆盖率

---

## 📈 项目健康度指标

| 指标 | 当前状态 | 目标 |
|------|----------|------|
| 文档覆盖率 | 100% | 100% ✅ |
| 超400行文件数 | 7个 | 0个 🔴 |
| 单元测试覆盖率 | 待完善 | 80%+ |
| 代码重复率 | 低 | <5% |
| 依赖循环 | 无 | 0个 ✅ |

---

*最后更新: 2025-08-31 17:46*
*维护者: FlowDesk 开发团队*
