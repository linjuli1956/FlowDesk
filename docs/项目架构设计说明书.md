# FlowDesk 项目架构设计说明书

## 1. 项目概述与目标
- **项目名称**：FlowDesk - 一体化Windows系统管理工具
- **版本**：v1.0 (当前) → v2.0 (未来集中化管理平台)
- **定位**：从本地化工具向专业IT运维平台演进
- **核心功能**：网络配置、网络工具、远程桌面、硬件监控四大模块
- **未来扩展**：集中化管理平台(C/S架构) + 集成式远程桌面屏幕墙
- **UI设计风格**：卡片式布局 + 彩色功能按钮 + 简洁实用的界面设计
- **窗口规格**：660×645像素紧凑布局，支持最小尺寸保护
- **平台兼容**：Windows 10、Windows 11 主要支持；Windows 7 兼容版本
- **技术栈**：Python 3.8+、PyQt5、LibreHardwareMonitor、标准库

## 2. 分层架构概览
- UI 层（View）：仅负责界面与交互，零业务逻辑。
- 服务层（Service）：封装业务与系统能力，向 UI 发射信号。
- 模型层（Model）：数据结构与类型定义，提供轻量校验/转换。
- 工具层（Utils）：通用工具、平台封装、日志等。

### 2.1 分层架构图（Mermaid）
```mermaid
flowchart TD
  subgraph UI[UI 层 (View)]
    MW[MainWindow]
    TABS[Tabs: ip_config / tools / rdp / hardware]
    WIDGETS[Widgets & Dialogs]
  end

  subgraph SERVICES[服务层 (Service)]
    NET[NetworkService]
    RDP[RdpService]
    HW[HardwareMonitorService]
    STG[SettingsService]
    TRAY[SystemTrayService]
  end

  subgraph MODELS[模型层 (Model)]
    ADAPTER[AdapterInfo]
    IPCFG[IPConfigInfo]
    DNS[DnsConfig]
    RDP_M[RdpSession]
    HW_M[HardwareMetrics]
  end

  subgraph UTILS[工具层 (Utils)]
    LOG[Logger]
    SUBP[Subprocess]
    WINAPI[Win APIs]
    VALID[Validators]
  end

  MW -->|Signals/Slots| SERVICES
  TABS --> MW
  WIDGETS --> MW

  SERVICES -->|emit signals w/ payloads| UI
  SERVICES <-->|consume/provide| UTILS
  SERVICES --> MODELS
  UI -->|render using| MODELS
```

## 3. 分层定义与约束
### 3.1 UI 层（View）
- 位置：`src/flowdesk/ui/`
- 组成：主窗口、标签页、对话框、自定义控件与外置 QSS。
- 约束：
  - 严禁业务逻辑与系统调用。
  - 仅订阅服务层信号，触发用户操作事件（发射轻量请求到服务层）。
  - 使用布局管理器与尺寸策略实现响应式布局；设定最小尺寸保护。

### 3.2 服务层（Service）
- 位置：`src/flowdesk/services/`
- 职责：
  - 业务流程编排（例如网卡信息获取、IP/DNS 配置、RDP 管理、硬件监控）。
  - 封装系统访问（调用 `utils` 或 Windows API）。
  - 向 UI 发射信号（PyQt Signals），不直接依赖具体 UI 组件。
- 信号通信：
  - 示例：`adapters_updated(list[AdapterInfo])`、`ip_config_applied(AdapterInfo)`、`hardware_metrics_updated(HardwareMetrics)`。

### 3.3 模型层（Model）
- 位置：`src/flowdesk/models/`
- 职责：
  - 定义数据类，如 `AdapterInfo`、`IPConfigInfo`、`DnsConfig`、`RdpSession`、`HardwareMetrics`。
  - 提供基本的构造校验与类型转换，避免 UI/Service 直接握手原始字典。

### 3.4 工具层（Utils）
- 位置：`src/flowdesk/utils/`
- 职责：
  - 日志、子进程、Windows 特定封装、验证器。
  - 对外提供稳定 API，避免服务层重复实现。

## 4. 信号通信规范
- 统一在服务类内部定义 `QtCore.pyqtSignal`，UI 仅连接槽函数。
- 信号命名：`<domain>_<event>`；示例：`network_adapters_updated`。
- 负载类型：使用模型层数据类，避免生字典。
- 触发时机：完成一次数据抓取/写入后立即发射，或在长任务中分段发射进度。

示例（伪代码）：
```python
class NetworkService(QObject):
    adapters_updated = pyqtSignal(list)  # list[AdapterInfo]
    ip_info_updated = pyqtSignal(object)  # IPConfigInfo
```

## 5. 兼容性与构建策略
### 5.1 Windows 10 / 11 运行要求
- Python 3.8+，PyQt5 5.15.x，避免使用 Qt6-only API。
- QSS 与控件使用 Qt5 支持的选择器与属性；不使用 CSS 变量语法在运行态，变量由构建/预处理注入。
- 系统接口优先通过 `netsh`/`GetAdaptersAddresses` 等稳定 API。

### 5.2 Windows 7 兼容构建
- Python 3.8、PyQt5 5.15.4（最后兼容 Win7 的组合，依据实际测试微调）。
- 依赖库选择避免使用需要 Win8+ API 的版本。
- 网络与硬件能力：
  - Netsh 命令在 Win7 上语法略有差异，封装兼容分支并在运行时判断 `platform.release()`。
  - LibreHardwareMonitor 组件需验证 Win7 下 .NET 依赖，如受限需降级或提供“禁用硬件监控”的构建开关。
- 打包：PyInstaller 4.x，使用 `--onefile` + `--add-data` 收拢资源；在 Win7 机器或 Win7 兼容工具链上构建。
- UI 降级策略：禁用不受支持的毛玻璃/模糊，提供 `compat_win7=true` 的样式分支（经 QSS 预处理生成）。

### 5.3 条件分支与能力检测
- 启动时能力检测：记录 OS 版本、可用命令、权限状态，决定启用/降级功能。
- 所有服务层对外暴露“功能可用性”属性，UI 根据此状态显示提示或禁用控件。

## 6. 配置与资源
- 外置 QSS：`src/flowdesk/ui/qss/main_pyqt5.qss` 唯一入口。
- 图标与 LHM 资源：位于 `assets/`，构建时通过打包脚本注入。
- 设置：`SettingsService` 负责加载/保存 JSON 配置，提供类型安全访问。

## 7. 日志与错误处理
- 统一 `utils.log` 提供结构化日志；关键路径记录操作、结果与错误。
- 服务层对系统错误进行语义化封装，发射失败信号附带错误码/建议。

## 8. 安全与权限
- 网络写入与系统托盘需管理员或特定权限；
- 提供权限检测与用户提示，必要时引导以管理员重启（仅在用户确认后）。

## 9. 性能与可维护性
- 长任务（扫描、监控）使用后台线程/定时器，避免阻塞主线程。
- 模块解耦、命名规范、注释标准遵循《UI调整注意事项.md》。

- UI：MainWindow、四大 Tab、常用 Dialogs、Tray 图标。

## 11. 定位与非目标（完全重写）
- 定位：本项目为"全新架构的绿色重写（Greenfield Rewrite）"。旧实现 `ip_manager_pyqt_full.py` 仅作为需求与兼容性参考，不导入任何既有代码或样式。
- 非目标：不做代码迁移/适配；不保留任何内联样式与面向过程结构；不保留耦合的托盘/权限/UI混杂实现。

## 12. 重写实施蓝图（高层）
- 模型优先：先冻结数据模型（AdapterInfo、IPConfigInfo、DnsConfig、RdpSession、HardwareMetrics、UserInfo）。
- 服务优先：实现信号驱动的 `NetworkService`、`HardwareMonitorService`、`SettingsService`、`SystemTrayService`、`UserService`，仅暴露模型化接口与信号。
{{ ... }}
- UI 后置：在服务接口稳定后构建纯 View（无业务），连接信号槽，应用唯一外置 QSS。
- 兼容优先：设计期引入 Win7 能力降级开关，保证 Win10/11 最优体验，Win7 可运行。

## 13. 硬件监控与外部资源（LHM 与图标）
- 资源保留：保留 `assets/LibreHardwareMonitor/` 下 DLL 与相关文件；保留 `assets/icons/` 图标资源，构建时打包入 EXE。
- 集成方式：
  - `HardwareMonitorService` 通过托管桥接或子进程方式调用 `LibreHardwareMonitorLib.dll` 暴露的指标（CPU 温度、风扇转速等）。
  - 提供能力检测：在 Win7 下验证 .NET 依赖可用性；不可用时发射 `capabilities.hw_monitor=false` 并在 UI 中降级隐藏/禁用相关显示。
  - 数据模型：`HardwareMetrics` 包含 `cpu_temp_celsius`、`fan_rpm`、`gpu_temp_celsius`、`time` 等字段。
- 打包策略：
  - PyInstaller `--add-binary` 或 `--add-data` 注入 LHM 与图标资源；运行时使用 `resource_path()` 定位。

## 14. UI 布局与可用性约束（强制）
- 自适应布局：全局使用 `QLayout` 实现伸缩；严禁绝对定位。
- 最小宽度保护：主窗口与关键容器设置 `setMinimumWidth/Height`，防止压缩导致错乱。
- 智能组件缩放：控件 `sizePolicy` 合理配置（输入/表格随窗口拉伸，按钮保守扩展）。
- 按钮样式单一定义：通用按钮基类样式定义一次，专用变体通过 `#objectName` 扩展，不得重复定义同一属性。

## 15. 核心服务清单（基于UI截图的实际功能需求）

### 15.1 网络配置服务 (NetworkService)
- **网卡管理**：枚举所有网卡、获取完整描述名称、状态检测（已连接/已禁用/未连接）
- **IP配置**：读取/设置IP地址、子网掩码、默认网关、DNS服务器
- **DHCP管理**：静态IP/DHCP模式切换
- **网卡控制**：启用/禁用网卡功能
- **额外IP管理**：添加/删除额外IP地址，支持多IP配置
- **信息复制**：格式化网卡信息到剪贴板
- **状态徽章**：连接状态、IP模式、网卡速率三个实时状态指示器

### 15.2 网络工具服务 (NetworkToolsService)
- **连通性测试**：内置Ping工具（非CMD弹窗），支持延迟阶梯颜色显示
- **路由追踪**：Traceroute功能，逐跳显示网络路径
- **系统工具集**：9个彩色功能按钮（3×3网格布局）
  - **第一行**：Winsock重置、防火墙允许Ping、防火墙禁止Ping
  - **第二行**：网络控制面板、Win11自动登录、清理浏览器缓存
  - **第三行**：修改计算机名、设备和打印机、添加系统用户
- **密码设置功能**：本机密码设置 + 启用远程桌面一键配置
- **智能填充**：IP地址输入框自动填入当前网卡网关，互联网测试默认www.baidu.com
- **状态检测**：防火墙Ping规则状态检测，Win11自动登录注册表状态检测

### 15.3 远程桌面服务 (RdpService)
- **连接管理器**：高级RDP连接配置窗口
- **历史记录**：连接记录持久化存储（隐藏JSON文件，软件同目录）
- **分组管理**：连接配置分组功能，支持新增分组
- **搜索功能**：历史记录关键词搜索，支持模糊匹配
- **凭据管理**：用户名/密码保存与自动填充（默认Administrator）
- **连接统计**：记录连接次数和使用频率
- **智能填充**：目标IP默认填入当前网卡主IP，端口默认3389
- **变更分组**：支持历史记录分组变更功能
- **未来扩展**：v2.0将集成屏幕墙功能，支持多台服务器并行监控

### 15.4 硬件监控服务 (HardwareMonitorService)
- **硬件信息采集**：CPU、GPU、内存、硬盘、主板、显示器、操作系统详细信息
- **实时监控**：温度、风扇转速、使用率等动态数据
- **悬浮窗显示**：Always-on-Top透明悬浮窗（默认右下角，可拖动）
- **悬浮窗配置**：右键菜单设置显示项与透明度
- **阶梯颜色策略**：根据数值范围应用不同颜色（温度、使用率等）
- **信息导出**：结构化硬件信息复制功能（含时间戳）
- **LibreHardwareMonitor集成**：通过LHM库获取硬件数据
- **卡片式展示**：硬件信息以卡片形式分类展示
- **实时网速**：显示上传/下载速度
- **未来扩展**：v2.0将支持硬件信息上报至管理平台

### 15.5 辅助服务
- **SettingsService**：配置持久化与偏好管理
- **SystemTrayService**：系统托盘集成
- **ValidationService**：IP地址等输入验证（统一IP验证类）
- **CapabilityService**：系统能力检测与Win7兼容性
- **ReportService**：(v2.0) 资产信息上报至管理平台
- **ScreenWallService**：(v2.0) 集成式远程桌面屏幕墙管理

## 16. 资源打包与路径
- 图标：`assets/icons/` 中 ICO/PNG 保留；构建注入并由 `resource_path()` 解析。
- LHM：`assets/LibreHardwareMonitor/` 完整保留；通过 `--add-binary` 或 `--add-data` 注入打包产物。
- 配置：用户目录 INI（`%APPDATA%/IPManager/settings.ini`）。

## 17. UI 组件与对象命名（基于实际UI截图）

### 17.1 网络配置页面 (网络配置 Tab)
- **网卡选择区域**：
  - `adapter_combo` - 网卡选择下拉框
  - `refresh_btn` - 刷新按钮 
- **当前IP信息展示**：
  - `ip_info_container` - IP信息展示容器（带滚动条）
  - `connection_status_badge` - 连接状态徽章
  - `ip_mode_badge` - 静态IP/DHCP徽章
  - `link_speed_badge` - 网卡速率徽章
- **IP配置区域**：
  - `ip_address_input` - IP地址输入框
  - `subnet_mask_input` - 子网掩码输入框
  - `gateway_input` - 默认网关输入框
  - `dns_input` - DNS服务器输入框
  - `current_adapter_label` - 当前网卡显示标签
- **操作按钮组**：
  - `modify_ip_btn` - 修改IP地址按钮 
  - `enable_adapter_btn` - 启用网卡按钮 
  - `disable_adapter_btn` - 禁用网卡按钮 
  - `set_static_btn` - 设置静态IP按钮 
  - `set_dhcp_btn` - 设置DHCP按钮 
  - `copy_info_btn` - 复制网卡信息按钮 
- **额外IP管理**：
  - `extra_ip_list` - 额外IP地址列表
  - `add_extra_ip_btn` - 添加额外IP按钮 
  - `add_selected_btn` - 添加选中按钮 
  - `remove_selected_btn` - 删除选中按钮 

### 17.2 网络工具页面 (网络工具 Tab)
- **连通性测试区域**：
  - `ping_ip_input` - IP地址输入框
  - `ping_start_btn` - 开始Ping按钮
  - `tracert_input` - 追踪路由输入框
  - `tracert_start_btn` - 开始追踪按钮
  - `internet_input` - 互联网测试输入框
  - `internet_start_btn` - 开始测试按钮
- **系统工具网格**（9个彩色按钮）：
  - `winsock_reset_btn` - Winsock重置（蓝色）
  - `fw_allow_ping_btn` - 防火墙Ping允许（绿色）
  - `fw_block_ping_btn` - 防火墙Ping禁止（红色）
  - `win11_autologin_btn` - Win11自动登录（紫色）
  - `clear_browser_cache_btn` - 清理浏览器缓存（蓝色）
  - `network_panel_btn` - 网络控制面板（青色）
  - `device_printer_btn` - 设备和打印机（橙色）
  - `user_management_btn` - 添加系统用户（绿色）
  - `computer_name_btn` - 修改计算机名（紫色）
- **密码设置区域**：
  - `password_input` - 本机密码输入框
  - `enable_rdp_btn` - 启用远程桌面按钮

### 17.3 远程桌面页面 (远程桌面 Tab)
- **连接说明区域**：
  - `rdp_description_label` - 连接功能说明
  - `rdp_features_list` - 功能特性列表
- **连接按钮**：
  - `connect_rdp_btn` - 连接远程桌面按钮

### 17.4 远程桌面连接窗口（弹窗）
- **连接配置**：
  - `target_ip_input` - 目标IP地址输入框
  - `port_input` - 端口号输入框
  - `group_combo` - 分组下拉框
  - `new_group_btn` - 新增分组按钮
- **历史记录管理**：
  - `history_combo` - 历史记录下拉框
  - `search_btn` - 搜索按钮
  - `change_group_btn` - 变更分组按钮
  - `current_group_label` - 当前分组显示
- **登录信息**：
  - `username_input` - 用户名输入框
  - `password_input` - 密码输入框（带显隐切换）
  - `remark_input` - 备注输入框
- **操作按钮**：
  - `cancel_btn` - 取消按钮（红色）
  - `save_btn` - 保存按钮（蓝色）
  - `connect_btn` - 连接按钮（绿色）

### 17.5 硬件信息页面 (硬件信息 Tab)
- **操作区域**：
  - `copy_hw_info_btn` - 复制信息按钮
  - `refresh_hw_btn` - 刷新硬件信息按钮
  - `status_label` - 状态显示（已刷新）
  - `float_window_checkbox` - 开启悬浮窗勾选框
- **硬件信息展示**：
  - `hw_info_container` - 硬件信息容器（卡片式布局）
  - `cpu_info_card` - CPU信息卡片
  - `gpu_info_card` - GPU信息卡片
  - `memory_info_card` - 内存信息卡片
  - `storage_info_card` - 存储设备卡片
  - `motherboard_info_card` - 主板信息卡片
  - `display_info_card` - 显示设备卡片
  - `system_info_card` - 操作系统卡片

### 17.6 悬浮窗组件
- **悬浮窗主体**：
  - `float_window` - 悬浮窗主窗口（Always-on-Top）
  - `cpu_temp_display` - CPU温度显示
  - `cpu_usage_display` - CPU使用率显示
  - `gpu_temp_display` - GPU温度显示
  - `disk_temp_display` - 硬盘温度显示
  - `ip_address_display` - 本机IP地址显示
  - `network_speed_display` - 实时网速显示
- **右键菜单**：
  - `settings_menu_item` - 设置菜单项
  - `exit_menu_item` - 退出菜单项

## 18. 交互与权限
- 管理员权限提示与可选提权重启：由 UI 调用 PermissionService 封装，结果反馈到状态栏，不在 UI 内弹业务对话框逻辑。
- 长任务均使用后台线程，通过进度信号回传。
- UI 仅为 View：
  - 只包含 Qt 组件、布局与信号槽连接；
  - 禁止出现业务逻辑、系统命令、线程管理、状态判定、数据解析；
  - UI 向服务层发起请求（方法调用）或订阅服务层信号更新视图。
- 服务层是唯一业务入口：
  - 系统调用（netsh、WMI、注册表、mstsc、cmdkey、LHM）全部在服务层实现；
  - 服务层与模型层对齐，所有对外数据以数据类输出；
  - 长任务放服务层线程，UI 仅接收进度信号。
- 模型层作为数据契约：
  - UI/Service 之间通过模型类交互，禁止传输生字典；
  - 字段校验与转换在模型构造或 Service 内部完成。
- 禁止事项（反模式）：
  - 在任何 Python 代码中调用 `setStyleSheet()` 设置控件样式；
  - 在 UI 类中执行 `subprocess`, `wmi`, `winreg`, `mstsc/cmdkey` 等；
  - 在 UI 类中创建线程、定时器执行业务任务；
  - 在 UI 中解析系统命令输出、WMI 对象或构造业务字符串。

## 20. 样式与资源（硬约束）
- 模块化 QSS 管理：运行时由 `StylesheetService` 按顺序加载7个QSS文件：`main_pyqt5.qss`（或`main_win7.qss`）+ 各Tab专用样式文件。
- 加载方式：由 `StylesheetService` 在应用启动时统一合并加载；UI 代码严禁调用 `setStyleSheet()`。
- 样式优先级：后加载的文件覆盖前面的相同选择器，确保模块化样式正确应用。
- 资源：图标与 LHM DLL 通过打包脚本注入并由 `resource_path()` 解析，不在代码中硬编码绝对路径。

## 21. 自适应与最小宽度保护（硬约束）
- 所有窗口/页面使用 `QLayout`（Grid/HBox/VBox/Form）；禁止绝对定位与固定像素布局。
- 主窗口 `minimumSize` ≥ 660x645；核心容器设置合理 `minimumWidth/Height`，缩放不重叠、不溢出。
- sizePolicy 策略：
  - 输入/表格：`Expanding`（水平随窗口增长），按钮：`Fixed/Preferred`（不拉伸变形）。
  - 列表/文本区：垂直方向 `Expanding`，保证内容区域可用。
- 智能缩放：多列布局设置 `setStretch` 配比；滚动区域用于信息面板；弹窗设定合理 `fixed/min` 尺寸。

## 22. 验收检查（必须全部通过）
- 架构：
  - UI 代码零业务调用；服务层单元测试可独立运行；模型类作为唯一数据载体。
- 样式：
  - 代码库全文无 `setStyleSheet(` 与 `!important`；仅存在 QSS 文件；按钮基类样式仅定义一次。
- 布局：
  - 手动拉伸窗口与最小化至 `minimumSize` 时，无控件重叠/截断；关键容器不溢出。
- 兼容：
  - Win10/11 正常加载主 QSS；Win7 自动加载降级 QSS 且运行不崩溃（可禁用 LHM）。